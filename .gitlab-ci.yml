image: google/cloud-sdk:slim

stages:
  - build
  - deploy

variables:
  REGION: asia-east1
  SERVICE_NAME: techjob
  GCLOUD_PROJECT_ID: crack-audio-477907-q9
  IMAGE_NAME: asia-docker.pkg.dev/$GCLOUD_PROJECT_ID/techjob/$SERVICE_NAME

.before_script_template: &auth_gcp
  - echo "$GCLOUD_SERVICE_ACCOUNT" > key.json
  - gcloud auth activate-service-account --key-file=key.json
  - gcloud config set project "$GCLOUD_PROJECT_ID"
  - gcloud config set run/region "$REGION"

build:
  stage: build
  script:
    - *auth_gcp
    - echo "ðŸ“¦ Building Docker image and submitting to Artifact Registry..."
    - gcloud builds submit --tag "$IMAGE_NAME" || true
    - sleep 30
    - |
      if gcloud artifacts docker images describe "$IMAGE_NAME" --format="value(name)" 2>/dev/null; then
        echo "âœ… Image exists in Artifact Registry"
      else
        echo "âŒ Build failed"
        exit 1
      fi

deploy_prod:
  stage: deploy
  only:
    - main
  script:
    - *auth_gcp
    - echo "ðŸš€ Deploying to Cloud Run (PROD)..."
    - >
      gcloud run deploy "$SERVICE_NAME"
      --image "$IMAGE_NAME"
      --platform managed
      --allow-unauthenticated
      --set-env-vars NODE_ENV=production